<!DOCTYPE html>
<html lang="es">
<head>`r`n<link rel="manifest" href="manifest.json">`r`n<meta name="theme-color" content="#2563eb">`r`n<link rel="manifest" href="manifest.json">`r`n<meta name="theme-color" content="#2563eb">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Examen TMA Parte 66 – v12 corregido</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>`r`n  body { -webkit-tap-highlight-color: transparent; }`r`n  input,select,textarea,button { font-size:16px; }`r`n  .btn-responsive { width:100%; max-width:100%; padding:1rem 1.25rem; font-size:18px; }`r`n  section { min-height:100vh; display:flex; flex-direction:column; justify-content:center; }`r`n  #start-screen, #quiz-screen, #result-screen, #admin-panel { position:absolute; top:0; left:0; width:100%; }`r`n  body { -webkit-tap-highlight-color: transparent; }`r`n  input,select,textarea,button { font-size:16px; }`r`n  .btn-responsive { width:100%; max-width:320px; }
  body { font-family: 'Inter', sans-serif; }
  .option-label {
    cursor: pointer;
    display: block;
    padding: 0.75rem 1rem;
    border: 2px solid #d1d5db;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    user-select: none;
  }
  .option-label:hover:not(.disabled) {
    border-color: #2563eb;
    background-color: #eff6ff;
  }
  input[type="radio"] { display: none; }
  input[type="radio"]:checked + .option-label {
    border-color: #2563eb;
    background-color: #eff6ff;
    font-weight: 600;
  }
  .option-label.correct {
    border-color: #22c55e;
    background-color: #dcfce7;
    color: #15803d;
    font-weight: 700;
    animation: pulse 0.5s ease-in-out;
  }
  .option-label.incorrect {
    border-color: #ef4444;
    background-color: #fee2e2;
    color: #b91c1c;
    font-weight: 700;
    animation: shake 0.3s ease-in-out;
  }
  .option-label.disabled { cursor: default; opacity: 0.7; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }
  @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }
  .doubt-indicator {
    background-color: #fef9c3; color: #a16207; padding: 2px 8px; border-radius: 12px; font-size: .8rem; font-weight: 600; margin-left: 10px; display: inline-block;
  }
  #admin-panel { display: none; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  .explanation {
    background-color: #f3f4f6; border-left: 4px solid #6b7280; padding: 12px; margin-top: 12px; border-radius: 0 8px 8px 0; white-space: pre-line;
  }
  #import-area, .edit-form-area { background-color: #f9fafb; border: 2px solid #cbd5e1; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
  .edit-form-area { margin-top: 1rem; margin-bottom: 1rem; }
  .question-admin-card { border: 1px solid #ddd; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background: #fff; box-shadow: 0 4px 16px rgba(0,0,0,0.03); }
  .question-admin-card .option { display: block; margin-bottom: 2px; }
  .question-admin-actions { margin-top: 0.5rem; }
  .result-option { display: block; padding: 0.5rem 1rem; border-radius: 0.4rem; margin-top: 0.4rem; border: 1px solid #e5e7eb; position: relative; font-size: 1rem; background: #fff; }
  .result-option.correct { color: #15803d; border-color: #22c55e; background: #f0fdf4; text-decoration: underline; text-decoration-color: #22c55e; text-decoration-thickness: 3px; }
  .result-option.incorrect { color: #b91c1c; border-color: #ef4444; background: #fef2f2; text-decoration: underline; text-decoration-color: #ef4444; text-decoration-thickness: 3px; }
  /* Modal de confirmación */
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: none; align-items: center; justify-content: center; z-index: 50; }
  .modal { background: white; border-radius: 0.75rem; padding: 1rem; max-width: 420px; width: 92vw; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
</style>
</head>
<body class="bg-gray-100 text-gray-800">
<div class="max-w-3xl bg-white p-6 sm:p-8 rounded-2xl shadow-lg my-8 mx-auto">
  <!-- Pantalla Inicio -->
  <section id="start-screen" aria-label="Pantalla de inicio del examen">
    <h1 class="text-3xl font-bold text-center mb-4">Examen LMA Parte 66 </h1>
    <p class="text-center mb-4">Que dios nos pille confesados</p>

    <div class="mb-4 flex justify-between items-center">
      <label for="mode-select" class="font-medium">Modo:</label>
      <select id="mode-select" class="border rounded p-2" aria-describedby="mode-desc">
        <option value="exam">Examen</option>
        <option value="review" selected>Repaso</option>
      </select>
    </div>
    <p id="mode-desc" class="sr-only">Selecciona modo Examen o Repaso</p>

    <div class="mb-4 flex flex-wrap gap-4 justify-center">
      <div>
        <label for="epigrafe-select" class="block mb-1 font-medium">Epígrafe:</label>
        <select id="epigrafe-select" class="border rounded p-2" aria-label="Epígrafe">
          <option value="all">Todos</option>
        </select>
      </div>
      <div>
        <label for="num-questions" class="block mb-1 font-medium"># Preguntas:</label>
        <input id="num-questions" type="number" min="1" max="52" value="24" class="border rounded p-2 w-20 text-center" aria-label="Número de preguntas" />
      </div>
    </div>

    <div class="flex justify-center gap-4 mb-4">
      <button id="start-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2" aria-label="Comenzar examen">Comenzar</button>
      <button id="admin-btn" class="bg-gray-500 text-white font-bold py-3 px-6 rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-offset-2" aria-label="Mostrar panel de administración">Administrar</button>
    </div>
    <div class="mt-3 flex justify-center gap-4">
      <button id="reset-prog-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" aria-label="Resetear progreso de preguntas">Resetear progreso</button>
    </div>
    <div id="admin-msg-area" class="mb-2 text-sm font-bold hidden"></div>
    <section id="stats-panel" class="mt-6 p-4 bg-gray-50 rounded" aria-label="Estadísticas Generales">
      <h3 class="font-semibold mb-2">Estadísticas Generales</h3>
      <ul id="stats-list" class="list-disc list-inside"></ul>
    </section>
  </section>

  <!-- Pantalla de Quiz -->
  <section id="quiz-screen" class="hidden" aria-live="polite" aria-label="Pantalla del cuestionario">
    <div class="flex justify-between items-center mb-4">
      <h2 class="font-semibold">Pregunta <span id="question-number"></span> de <span id="total-questions-display"></span></h2>
      <div class="flex items-center">
        <input type="checkbox" id="doubt-checkbox" class="mr-2" aria-label="Marcar duda en la pregunta" />
        <label for="doubt-checkbox" class="select-none cursor-pointer">Duda</label>
        <span id="doubt-indicator" class="doubt-indicator hidden" aria-live="polite">Duda marcada</span>
      </div>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2" aria-hidden="true">
      <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width:0%"></div>
    </div>
    <p class="text-sm text-gray-600 mb-4"><span id="progress-fraction">0/0</span></p>
    <p id="question-text" class="font-medium mb-4 min-h-[80px]" tabindex="0"></p>
    <form id="options-form" aria-label="Opciones de respuesta"></form>
    <div id="explanation-container"></div>
    <div class="mt-6 flex justify-between">
      <button id="prev-btn" class="bg-gray-500 text-white py-2 px-4 rounded disabled:opacity-50" disabled aria-disabled="true">Anterior</button>
      <button id="next-btn" class="bg-blue-600 text-white py-2 px-4 rounded" aria-disabled="false">Siguiente</button>
    </div>
  </section>

  <!-- Pantalla Resultados -->
  <section id="result-screen" class="hidden" aria-label="Pantalla de resultados" tabindex="0">
    <div class="text-center mb-6">
      <h2 class="text-2xl font-bold mb-2">Resultados</h2>
      <p id="score-text" class="text-4xl font-bold mb-2" aria-live="polite"></p>
      <p id="score-feedback"></p>
      <div class="flex gap-3 justify-center mt-4">
        <button id="restart-btn" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2" aria-label="Reiniciar examen">Reiniciar</button>
        <button id="back-home-btn" class="bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-offset-2" aria-label="Volver al inicio">Inicio</button>
      </div>
    </div>
    <hr class="mb-6" />
    <div id="review-container" class="space-y-6"></div>
  </section>

  <!-- Panel Administración -->
  <section id="admin-panel" class="mt-4 p-4 bg-gray-50 rounded" aria-label="Panel de administración">
    <h3 class="font-semibold mb-2">Panel de Administración</h3>
    <div class="flex flex-wrap gap-3 mb-3">
      <button type="button" id="btn-upload-file" class="bg-blue-600 text-white py-2 px-3 rounded">Subir archivo</button>
      <button type="button" id="btn-upload-url" class="bg-blue-600 text-white py-2 px-3 rounded">Importar desde URL</button>
      <button type="button" id="btn-upload-json" class="bg-blue-600 text-white py-2 px-3 rounded">Pegar JSON</button>
      <button id="export-questions-btn" class="bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700" type="button">Exportar preguntas (JSON)</button>
      <button id="export-stats-btn" class="bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700" type="button">Exportar estadísticas (JSON)</button>
      <input type="file" id="file-upload" accept=".json" class="border rounded p-2" style="display:none;">
	<button id="delete-all-btn" class="bg-red-700 text-white py-2 px-4 rounded hover:bg-red-800 mt-2">  Borrar todas las preguntas </button>

    </div>
    <div id="import-area" style="display:none;">
      <input type="text" id="import-url" class="border rounded p-2 w-full mb-2" placeholder="Pega aquí el enlace a tu archivo .json" style="display:none;">
      <textarea id="import-json" rows="6" class="border rounded p-2 w-full mb-2" placeholder="Pega aquí el JSON de preguntas" style="display:none;"></textarea>
      <button type="button" id="btn-confirm-import" class="bg-green-600 text-white py-2 px-4 rounded">Importar preguntas</button>
      <button type="button" id="btn-cancel-import" class="bg-gray-400 text-white py-2 px-4 rounded">Cancelar</button>
      <div id="import-error" class="text-red-600 mt-1"></div>
    </div>
    <hr class="my-4">
    <div>
      <h4 class="font-semibold mb-1">Buscar pregunta:</h4>
      <input type="text" id="admin-search" class="border rounded p-2 w-full mb-2" placeholder="Buscar por texto o epígrafe..."/>
      <div id="admin-questions-list" tabindex="0" aria-live="polite"></div>
    </div>
    <div id="edit-question-area" class="edit-form-area hidden" aria-live="polite" aria-label="Editar pregunta"></div>
  </section>
</div>

<!-- Modal de confirmación -->
<div id="confirm-backdrop" class="modal-backdrop">
  <div class="modal">
    <h3 id="confirm-title" class="font-semibold text-lg mb-2">Confirmar</h3>
    <p id="confirm-text" class="text-gray-700 mb-4">¿Seguro?</p>
    <div class="flex justify-end gap-2">
      <button id="confirm-cancel" class="bg-gray-200 px-3 py-2 rounded">Cancelar</button>
      <button id="confirm-ok" class="bg-red-600 text-white px-3 py-2 rounded">Sí, continuar</button>
    </div>
  </div>
</div>

<script>
(() => {
  const DEFAULT_EF = 2.5;
  const $ = sel => document.querySelector(sel);

  function generateUID() {
    return (
      Date.now().toString(36) +
      Math.random().toString(36).substr(2, 9) +
      Math.random().toString(36).substr(2, 4)
    );
  }

  // Banco por defecto (IDs como strings para consistencia)
  let allQuestions = JSON.parse(localStorage.getItem('qBank')) || [
    {id: generateUID(), epigrafe: 15, question: "¿prueba?", options:["Protón","Electrón","Neutrón"], answer:1, explanation:"El electrón tiene carga negativa."},
    {id: generateUID(), epigrafe: 15, question: "¿Prueba2?", options:["Arranca con más potencia","No arranca por falta de campo giratorio","Funciona normalmente pero con menor velocidad"], answer:1, explanation:"Con una sola fase no hay campo giratorio."}
  ];
  let reps = JSON.parse(localStorage.getItem('reps')) || {};

  function saveBank() { localStorage.setItem('qBank', JSON.stringify(allQuestions)); }
  function saveReps() { localStorage.setItem('reps', JSON.stringify(reps)); }

  function downloadJSON(jsonString, filename) {
    const blob = new Blob([jsonString], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.style.display = 'none';
    document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
  }

  function showMessage(elem, msg, isError = false) {
    elem.textContent = msg; elem.classList.remove('hidden');
    if (isError) { elem.classList.remove('text-green-600'); elem.classList.add('text-red-600'); }
    else { elem.classList.remove('text-red-600'); elem.classList.add('text-green-600'); }
    setTimeout(() => { elem.classList.add('hidden'); elem.textContent = ''; }, 4000);
  }

  // Modal de confirmación accesible
  function confirmModal(text = '¿Seguro?', title = 'Confirmar') {
    return new Promise(resolve => {
      const backdrop = $('#confirm-backdrop');
      $('#confirm-title').textContent = title;
      $('#confirm-text').textContent = text;
      backdrop.style.display = 'flex';
      const onCancel = () => { cleanup(); resolve(false); };
      const onOk = () => { cleanup(); resolve(true); };
      const cleanup = () => {
        backdrop.style.display = 'none';
        $('#confirm-cancel').removeEventListener('click', onCancel);
        $('#confirm-ok').removeEventListener('click', onOk);
      };
      $('#confirm-cancel').addEventListener('click', onCancel);
      $('#confirm-ok').addEventListener('click', onOk);
    });
  }

  const epSel = $('#epigrafe-select');
  const statsList = $('#stats-list');
  const adminPanel = $('#admin-panel');
  const adminMsgArea = $('#admin-msg-area');
  const editQuestionArea = $('#edit-question-area');
  const startScreen = $('#start-screen');
  const quizScreen = $('#quiz-screen');
  const resultScreen = $('#result-screen');
  const modeSelect = $('#mode-select');
  const startBtn = $('#start-btn');
  const adminBtn = $('#admin-btn');
  const resetProgBtn = $('#reset-prog-btn');
  const btnUploadFile = $('#btn-upload-file');
  const fileUpload = $('#file-upload');
  const btnUploadUrl = $('#btn-upload-url');
  const btnUploadJson = $('#btn-upload-json');
  const importArea = $('#import-area');
  const importUrl = $('#import-url');
  const importJson = $('#import-json');
  const btnConfirmImport = $('#btn-confirm-import');
  const btnCancelImport = $('#btn-cancel-import');
  const importError = $('#import-error');
  const exportQuestionsBtn = $('#export-questions-btn');
  const exportStatsBtn = $('#export-stats-btn');
	const deleteAllBtn = $('#delete-all-btn');
	
  const questionNumberEl = $('#question-number');
  const totalQuestionsEl = $('#total-questions-display');
  const progressFractionEl = $('#progress-fraction');
  const questionText = $('#question-text');
  const optionsForm = $('#options-form');
  const explanationContainer = $('#explanation-container');
  const prevBtn = $('#prev-btn');
  const nextBtn = $('#next-btn');
  const doubtCheckbox = $('#doubt-checkbox');
  const doubtIndicator = $('#doubt-indicator');
  const scoreText = $('#score-text');
  const scoreFeedback = $('#score-feedback');
  const restartBtn = $('#restart-btn');
  const backHomeBtn = $('#back-home-btn');
  const reviewContainer = $('#review-container');
  const numQuestionsInput = $('#num-questions');
  const adminSearch = $('#admin-search');

  let mode = 'review', pool = [], currentQuestions = [], idx = 0;
  let userAnswers = [], doubts = new Set(), editingQuestionId = null, answered = false;

  window.addEventListener('DOMContentLoaded', () => {
    populateEpigrafes();
    updateStats();
    modeSelect.value = 'review';
    mode = 'review';
  });

  function populateEpigrafes() {
    for (let i = epSel.options.length - 1; i >= 1; i--) epSel.remove(i);
    const epSet = new Set(allQuestions.map(q => q.epigrafe));
    [...epSet].sort((a,b) => a - b).forEach(e => {
      const opt = document.createElement('option');
      opt.value = e; opt.textContent = e; epSel.appendChild(opt);
    });
  }

  function updateStats(){
    const stats = {}; const totalByEpigrafe = {}; const unansweredByEpigrafe = {}; const now = Date.now();
    allQuestions.forEach(q => { totalByEpigrafe[q.epigrafe] = (totalByEpigrafe[q.epigrafe] || 0) + 1; });
    allQuestions.forEach(q => { const r = reps[q.id]; if(!r || r.next <= now) { unansweredByEpigrafe[q.epigrafe] = (unansweredByEpigrafe[q.epigrafe] || 0) +1; } });
    Object.values(reps).forEach(r => { if(!stats[r.epigrafe]) stats[r.epigrafe] = { correct: 0, total: 0 }; stats[r.epigrafe].total++; if(r.lastResult) stats[r.epigrafe].correct++; });
    statsList.innerHTML = '';
    if(Object.keys(stats).length === 0) { const li = document.createElement('li'); li.textContent = 'No hay estadísticas disponibles.'; statsList.appendChild(li); }
    Object.entries(totalByEpigrafe).forEach(([epi, totalQ]) => {
      const stat = stats[epi] || {correct:0,total:0};
      const pct = stat.total ? Math.round((stat.correct/stat.total)*100) : 0;
      const noRespondidas = unansweredByEpigrafe[epi] || 0;
      const li = document.createElement('li');
      li.textContent = `Epígrafe ${epi}: ${pct}% (${stat.correct} de ${stat.total} correctas) - Preguntas totales: ${totalQ} - Sin responder: ${noRespondidas}`;
      statsList.appendChild(li);
    });
    const totalPreguntas = allQuestions.length;
    const totalSinResponder = Object.values(unansweredByEpigrafe).reduce((a,b) => a+b, 0);
    const liTotal = document.createElement('li');
    liTotal.textContent = `Totales preguntas: ${totalPreguntas} - Sin responder: ${totalSinResponder}`;
    liTotal.style.fontWeight = 'bold'; statsList.appendChild(liTotal);
  }

  function toggleAdminPanel() {
    if (adminPanel.style.display === 'none' || adminPanel.style.display === '') {
      adminPanel.style.display = 'block'; adminBtn.setAttribute('aria-pressed', 'true'); adminSearch.value = ''; renderQuestionsList();
    } else { adminPanel.style.display = 'none'; adminBtn.setAttribute('aria-pressed', 'false'); }
  }
  adminBtn.addEventListener('click', toggleAdminPanel);

  resetProgBtn.addEventListener('click', async () => {
    const ok = await confirmModal('Esto marcará todas las preguntas como no vistas.', 'Resetear progreso');
    if (!ok) return;
    reps = {}; saveReps(); updateStats(); showMessage(adminMsgArea, 'Progreso resetado correctamente.');
  });

  btnUploadFile.addEventListener('click', () => fileUpload.click());
  fileUpload.addEventListener('change', (e) => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => { try { importarPreguntas(JSON.parse(ev.target.result)); } catch { showMessage(adminMsgArea, 'Archivo JSON no válido.', true); } };
    reader.readAsText(file);
  });

  btnUploadUrl.addEventListener('click', () => { importArea.style.display = 'block'; importUrl.style.display = 'block'; importUrl.value = ''; importJson.style.display = 'none'; importError.textContent = ''; });
  btnUploadJson.addEventListener('click', () => { importArea.style.display = 'block'; importJson.style.display = 'block'; importJson.value = ''; importUrl.style.display = 'none'; importError.textContent = ''; });
  btnCancelImport.addEventListener('click', () => { importArea.style.display = 'none'; importUrl.value = ''; importJson.value = ''; importError.textContent = ''; });

  btnConfirmImport.addEventListener('click', async () => {
    let data = null;
    if(importUrl.style.display === 'block') {
      try { const resp = await fetch(importUrl.value.trim()); if (!resp.ok) throw new Error('Error en descarga'); data = await resp.json(); }
      catch { importError.textContent = 'No se pudo cargar o el JSON es incorrecto.'; return; }
    } else {
      try { data = JSON.parse(importJson.value); }
      catch { importError.textContent = 'El JSON pegado no es válido.'; return; }
    }
    importarPreguntas(data); importArea.style.display = 'none';
  });

  exportQuestionsBtn.addEventListener('click', () => { downloadJSON(JSON.stringify(allQuestions, null, 2), 'preguntas.json'); showMessage(adminMsgArea, 'Banco de preguntas exportado con éxito.'); });
  exportStatsBtn.addEventListener('click', () => { downloadJSON(JSON.stringify(reps, null, 2), 'estadisticas.json'); showMessage(adminMsgArea, 'Estadísticas exportadas con éxito.'); });


deleteAllBtn.addEventListener('click', async () => {
  const ok = await confirmModal('Se borrarán TODAS las preguntas y el progreso asociado. Esta acción no se puede deshacer.', 'Borrar todas las preguntas');
  if (!ok) return;

  allQuestions = [];
  reps = {};
  saveBank();
  saveReps();
  populateEpigrafes();
  updateStats();
  renderQuestionsList();
  showMessage(adminMsgArea, 'Todas las preguntas fueron borradas correctamente.');
});



  function importarPreguntas(data) {
    if (!Array.isArray(data)) { showMessage(adminMsgArea, 'El formato debe ser un array de preguntas.', true); return; }
    let added = 0;
    data.forEach(q => {
      if (typeof q.epigrafe === 'number' && typeof q.question === 'string' && Array.isArray(q.options) && typeof q.answer === 'number') {
        allQuestions.push({ id: generateUID(), epigrafe: q.epigrafe, question: q.question, options: q.options, answer: q.answer, explanation: q.explanation || '' });
        added++;
      }
    });
    if (added > 0) { saveBank(); populateEpigrafes(); updateStats(); showMessage(adminMsgArea, `Importadas ${added} preguntas nuevas.`); renderQuestionsList(); }
    else { showMessage(adminMsgArea, 'No se añadieron preguntas válidas.', true); }
  }

  function renderQuestionsList() {
    const listContainer = $('#admin-questions-list'); listContainer.innerHTML = '';
    let filtro = adminSearch.value.toLowerCase().trim();
    let filtered = allQuestions.filter(q => q.question.toLowerCase().includes(filtro) || String(q.epigrafe).includes(filtro));
    if(filtered.length === 0) { listContainer.textContent = 'No se encontraron preguntas.'; return; }
    filtered.forEach(q => {
      const card = document.createElement('div'); card.className = 'question-admin-card'; card.tabIndex = 0;
      const tema = document.createElement('p'); tema.textContent = `Epígrafe: ${q.epigrafe}`; tema.className = 'font-semibold mb-1 inline-block'; card.appendChild(tema);
      if(reps[q.id] && reps[q.id].duda){ const duda = document.createElement('span'); duda.className = 'doubt-indicator ml-2'; duda.textContent = 'Con duda'; card.appendChild(duda); }
      const texto = document.createElement('p'); texto.textContent = q.question; card.appendChild(texto);
      q.options.forEach((opt,i) => { const optDiv = document.createElement('div'); optDiv.textContent = `${i}. ${opt}` + (i === q.answer ? ' (Correcta)' : ''); optDiv.className = 'option mt-1'; card.appendChild(optDiv); });
      if(q.explanation) { const expl = document.createElement('p'); expl.textContent = `Explicación: ${q.explanation}`; expl.className = 'text-sm italic mt-2'; card.appendChild(expl); }
      const acciones = document.createElement('div'); acciones.className = 'question-admin-actions';
      const btnEdit = document.createElement('button'); btnEdit.textContent = 'Editar'; btnEdit.className = 'mr-2 bg-yellow-400 hover:bg-yellow-500 text-black rounded px-3 py-1'; btnEdit.onclick = () => editQuestion(q.id);
      const btnDel = document.createElement('button'); btnDel.textContent = 'Eliminar'; btnDel.className = 'bg-red-600 hover:bg-red-700 text-white rounded px-3 py-1'; btnDel.onclick = () => deleteQuestion(q.id);
      acciones.appendChild(btnEdit); acciones.appendChild(btnDel); card.appendChild(acciones);
      listContainer.appendChild(card);
    });
  }
  adminSearch.addEventListener('input', renderQuestionsList);

  function editQuestion(id) {
    const q = allQuestions.find(x => x.id === id); if(!q) return; editQuestionArea.innerHTML = '';
    const form = document.createElement('form'); form.className = 'space-y-3';
    function escapeHtml(text) { if(!text) return ''; return text.replace(/[<>&"']/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;','\'':'&#39;'}[c])); }
    form.innerHTML = `
      <div><label class="block font-semibold mb-1">Epígrafe:</label><input name="epigrafe" type="number" min="0" value="${q.epigrafe}" required class="border rounded p-1 w-20"></div>
      <div><label class="block font-semibold mb-1">Pregunta:</label><input name="question" type="text" value="${escapeHtml(q.question)}" required class="border rounded p-1 w-full"></div>
      <div><label class="block font-semibold mb-1">Opciones (separadas por "|"):</label><input name="options" type="text" value="${escapeHtml(q.options.join('|'))}" required class="border rounded p-1 w-full"></div>
      <div><label class="block font-semibold mb-1">Índice respuesta correcta (0-based):</label><input name="answer" type="number" min="0" value="${q.answer}" required class="border rounded p-1 w-20"></div>
      <div><label class="block font-semibold mb-1">Explicación:</label><input name="explanation" type="text" value="${escapeHtml(q.explanation)}" class="border rounded p-1 w-full"></div>
      <div class="flex gap-3"><button type="submit" class="bg-green-600 text-white py-1 px-4 rounded hover:bg-green-700">Guardar</button><button type="button" id="cancel-edit" class="bg-gray-400 text-white py-1 px-4 rounded hover:bg-gray-500">Cancelar</button></div>
      <p id="edit-form-error" class="text-red-600 font-semibold mt-2 hidden"></p>
    `;
    editQuestionArea.appendChild(form); editQuestionArea.classList.remove('hidden'); adminMsgArea.textContent = ''; adminMsgArea.classList.add('hidden');
    const editError = form.querySelector('#edit-form-error');
    form.onsubmit = e => {
      e.preventDefault(); editError.classList.add('hidden'); const f = e.target;
      try {
        const epigrafeVal = Number(f.epigrafe.value.trim());
        const questionVal = f.question.value.trim();
        const optionsVal = f.options.value.trim();
        const answerVal = Number(f.answer.value.trim());
        const explanationVal = f.explanation.value.trim();
        if(isNaN(epigrafeVal) || epigrafeVal < 0) throw new Error('Epígrafe inválido.');
        if(!questionVal) throw new Error('La pregunta no puede estar vacía.');
        if(!optionsVal) throw new Error('Las opciones no pueden estar vacías.');
        const optsArray = optionsVal.split('|').map(s => s.trim()).filter(s => s);
        if(optsArray.length < 2) throw new Error('Se requieren al menos dos opciones válidas.');
        if(new Set(optsArray).size !== optsArray.length) throw new Error('No debe haber opciones repetidas.');
        if(optsArray.join('').length > 250) throw new Error('Opciones demasiado largas.');
        if(isNaN(answerVal) || answerVal < 0 || answerVal >= optsArray.length) throw new Error('Índice de respuesta inválido.');
        q.epigrafe = epigrafeVal; q.question = questionVal; q.options = optsArray; q.answer = answerVal; q.explanation = explanationVal;
        saveBank(); populateEpigrafes(); updateStats(); renderQuestionsList(); editQuestionArea.classList.add('hidden'); adminMsgArea.textContent = 'Pregunta guardada.'; adminMsgArea.classList.remove('hidden');
      } catch(err) { editError.textContent = err.message; editError.classList.remove('hidden'); }
    };
    form.querySelector('#cancel-edit').onclick = () => { editQuestionArea.classList.add('hidden'); };
  }

  async function deleteQuestion(id) {
    const ok = await confirmModal('Esta acción es irreversible.', 'Eliminar pregunta');
    if(!ok) return;
    allQuestions = allQuestions.filter(q => q.id !== id); delete reps[id]; saveBank(); saveReps(); populateEpigrafes(); updateStats(); renderQuestionsList(); adminMsgArea.textContent = 'Pregunta eliminada.'; adminMsgArea.classList.remove('hidden');
  }

  modeSelect.addEventListener('change', e => { mode = e.target.value; });
  startBtn.addEventListener('click', startQuiz);
  restartBtn.addEventListener('click', () => resetToStart());
  backHomeBtn.addEventListener('click', () => resetToStart());
  prevBtn.addEventListener('click', () => { if(idx > 0) { idx--; showQuestion(); } });
  nextBtn.addEventListener('click', () => {
    if (!isAnswerSelected()) { showMessage(adminMsgArea, 'Selecciona una respuesta antes de continuar.', true); return; }
    if (idx < currentQuestions.length - 1) { idx++; answered = false; showQuestion(); }
    else { showResults(); }
  });

  doubtCheckbox.addEventListener('change', e => {
    if(e.target.checked) { doubts.add(idx); doubtIndicator.classList.remove('hidden'); doubtCheckbox.setAttribute('aria-checked', 'true'); }
    else { doubts.delete(idx); doubtIndicator.classList.add('hidden'); doubtCheckbox.setAttribute('aria-checked', 'false'); }
  });

  function isAnswerSelected() { return userAnswers[idx] !== null && userAnswers[idx] !== undefined; }

  function startQuiz() {
    const ep = epSel.value; const numQ = parseInt(numQuestionsInput.value, 10);
    if (isNaN(numQ) || numQ < 1) { showMessage(adminMsgArea, 'Número de preguntas inválido.', true); return; }
    pool = allQuestions.filter(q => ep === 'all' || q.epigrafe == ep).filter(q => { const r = reps[q.id] || { next: 0 }; return r.next <= Date.now(); });
    if(pool.length === 0){ showMessage(adminMsgArea, 'No hay preguntas disponibles para este filtro.', true); return; }
    let adjustedNum = Math.min(numQ, pool.length);
    if(numQ > pool.length){ showMessage(adminMsgArea, `Sólo hay ${pool.length} preguntas sin responder para el epígrafe seleccionado. Se ajusta el número.`, true); }
    pool.sort(() => Math.random() - 0.5);
    currentQuestions = pool.slice(0, adjustedNum);
    userAnswers = new Array(currentQuestions.length).fill(null);
    doubts.clear(); idx = 0; answered = false;
    startScreen.classList.add('hidden'); adminPanel.style.display = 'none'; quizScreen.classList.remove('hidden'); resultScreen.classList.add('hidden');
    totalQuestionsEl.textContent = currentQuestions.length; showQuestion();
  }

  function showQuestion() {
    const q = currentQuestions[idx];
    questionNumberEl.textContent = idx + 1; questionText.textContent = q.question; explanationContainer.innerHTML = ''; explanationContainer.style.display = 'none';
    const progressPercent = ((idx + 1) / currentQuestions.length) * 100; $('#progress-bar').style.width = `${progressPercent}%`;
    progressFractionEl.textContent = `${idx + 1}/${currentQuestions.length}`;
    prevBtn.disabled = idx === 0; prevBtn.setAttribute('aria-disabled', prevBtn.disabled.toString());
    nextBtn.textContent = idx === currentQuestions.length - 1 ? 'Finalizar' : 'Siguiente';
    optionsForm.innerHTML = '';
    doubtCheckbox.checked = doubts.has(idx); doubtIndicator.classList.toggle('hidden', !doubts.has(idx)); doubtCheckbox.setAttribute('aria-checked', doubtCheckbox.checked.toString());
    answered = false;

    q.options.forEach((opt, i) => {
      const radio = document.createElement('input');
      const rid = `option-${idx}-${i}`; // IDs únicos por pregunta
      radio.type = 'radio'; radio.id = rid; radio.name = `option-${idx}`; radio.value = i;
      radio.checked = userAnswers[idx] === i; radio.setAttribute('aria-checked', radio.checked.toString());
      radio.addEventListener('change', () => {
        userAnswers[idx] = i;
        if(mode === 'review') {
          if(answered) return; answered = true; showAnswerFeedback(q, i);
        }
        nextBtn.disabled = false; nextBtn.setAttribute('aria-disabled', 'false');
      });
      const label = document.createElement('label'); label.htmlFor = rid; label.className = 'option-label flex items-center gap-2';
      label.innerHTML = `<span class="sr-only">Opción ${i+1}:</span><span>${opt}</span>`;
      optionsForm.appendChild(radio); optionsForm.appendChild(label);
    });

    // Estado inicial del botón siguiente por modo
    if(mode === 'review') { nextBtn.disabled = !isAnswerSelected(); nextBtn.setAttribute('aria-disabled', nextBtn.disabled.toString()); }
    if(mode === 'exam') { nextBtn.disabled = !isAnswerSelected(); nextBtn.setAttribute('aria-disabled', nextBtn.disabled.toString()); }

    // Si ya había respuesta (volver atrás), repinta feedback en repaso
    if(mode === 'review' && userAnswers[idx] !== null && userAnswers[idx] !== undefined) {
      showAnswerFeedback(q, userAnswers[idx], true); answered = true; nextBtn.disabled = false; nextBtn.setAttribute('aria-disabled', 'false');
    }

    questionText.focus();
  }

  function showAnswerFeedback(q, selectedIndex, fromLoad=false) {
    const labels = optionsForm.querySelectorAll('label.option-label');
    const radios = optionsForm.querySelectorAll('input[type=radio]');
    labels.forEach((lbl, i) => {
      lbl.classList.remove('correct', 'incorrect', 'disabled');
      radios[i].disabled = true; lbl.classList.add('disabled');
      if(i === q.answer) { lbl.classList.add('correct'); lbl.insertAdjacentHTML('beforeend', ' <span aria-hidden="true">✔</span>'); }
      if(i === selectedIndex && i !== q.answer) { lbl.classList.add('incorrect'); lbl.insertAdjacentHTML('beforeend', ' <span aria-hidden="true">✖</span>'); }
    });
    explanationContainer.style.display = 'block'; explanationContainer.className = 'explanation'; explanationContainer.textContent = q.explanation || 'No hay explicación.';

    if(!fromLoad) {
      const now = Date.now(); const qid = q.id; let r = reps[qid] || { ef: DEFAULT_EF, rep: 0, interval: 0, epigrafe: q.epigrafe };
      const isCorrect = selectedIndex === q.answer;
      if (isCorrect) { r.rep++; if (r.rep === 1) r.interval = 1; else if (r.rep === 2) r.interval = 6; else r.interval = Math.round(r.interval * r.ef); r.ef = Math.max(1.3, r.ef + 0.1); r.next = now + r.interval * 24 * 60 * 60 * 1000; }
      else { r.rep = 0; r.interval = 0; r.next = now; }
      r.lastResult = isCorrect; reps[qid] = r; saveReps(); updateStats();
    }
  }

  function showResults() {
    quizScreen.classList.add('hidden'); resultScreen.classList.remove('hidden');
    let correctCount = 0; currentQuestions.forEach((q, i) => { if(userAnswers[i] === q.answer) correctCount++; if(mode === 'exam') { applySM2(q, userAnswers[i] === q.answer); } });
    if(mode === 'exam') saveReps(); updateStats();
    const pct = Math.round((correctCount / currentQuestions.length) * 100);
    scoreText.textContent = `${pct}%`;
    scoreFeedback.textContent = pct >= 75 ? '¡Aprobado!' : 'No aprobado, sigue entrenando.';
    reviewContainer.innerHTML = '';
    currentQuestions.forEach((q, i) => {
      const block = document.createElement('section'); block.className = 'p-3 border rounded bg-white shadow';
      const qTitle = document.createElement('p'); qTitle.className = 'font-semibold mb-2'; qTitle.textContent = `${i + 1}. ${q.question}`; block.appendChild(qTitle);
      q.options.forEach((opt, j) => {
        const optDiv = document.createElement('div'); optDiv.textContent = opt; optDiv.className = 'result-option';
        if(j === q.answer) { optDiv.classList.add('correct'); }
        if(userAnswers[i] === j && j !== q.answer) { optDiv.classList.add('incorrect'); }
        block.appendChild(optDiv);
      });
      if(q.explanation) { const expDiv = document.createElement('div'); expDiv.className = 'explanation mt-2 bg-gray-100 p-2 rounded border-l-4 border-gray-400'; expDiv.textContent = `Explicación: ${q.explanation}`; block.appendChild(expDiv); }
      if(doubts.has(i)) { const doubtMark = document.createElement('div'); doubtMark.className = 'doubt-indicator mt-2'; doubtMark.textContent = 'Pregunta marcada con duda'; block.appendChild(doubtMark); }
      reviewContainer.appendChild(block);
    });
    scoreText.focus();
  }

  function applySM2(question, isCorrect) {
    const now = Date.now(); const qid = question.id; let r = reps[qid] || { ef: DEFAULT_EF, rep: 0, interval: 0, epigrafe: question.epigrafe };
    if(isCorrect) { r.rep++; if(r.rep === 1) r.interval = 1; else if(r.rep === 2) r.interval = 6; else r.interval = Math.round(r.interval * r.ef); r.ef = Math.max(1.3, r.ef + 0.1); r.next = now + r.interval * 24 * 60 * 60 * 1000; }
    else { r.rep = 0; r.interval = 0; r.next = now; }
    r.lastResult = isCorrect; reps[qid] = r;
  }

  function resetToStart() {
    // Reinicia estados sin recargar la página
    currentQuestions = []; pool = []; idx = 0; userAnswers = []; doubts.clear(); answered = false;
    quizScreen.classList.add('hidden'); resultScreen.classList.add('hidden'); startScreen.classList.remove('hidden'); adminPanel.style.display = 'none';
    questionNumberEl.textContent = '0'; totalQuestionsEl.textContent = '0'; progressFractionEl.textContent = '0/0'; $('#progress-bar').style.width = '0%';
  }
})();
</script>
</html>
